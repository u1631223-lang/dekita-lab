# アーキテクチャ設計

すべての設計判断は、「科学的根拠に基づいた楽しい達成体験を持続させ、将来的な多プラットフォーム展開に耐えうる基盤を構築する」という目的に紐づける。

## ハイレベル構成図
```
┌────────────┐        ┌──────────────────┐        ┌─────────────────┐
│  Game Hub  │ ───▶── │  Core Engine     │ ───▶── │  Reward System  │
└────────────┘        └──────────────────┘        └─────────────────┘
        │                      │                           │
        │                      ▼                           ▼
        │            ┌────────────────┐          ┌─────────────────────┐
        │            │ Adaptive Logic │ ◀──────▶ │ Telemetry Store      │
        │            └────────────────┘          └─────────────────────┘
        │                      │                           │
        ▼                      ▼                           ▼
┌────────────────┐   ┌────────────────────┐        ┌─────────────────────┐
│ Rhythm Module  │   │ Pair Match Module  │        │ Caregiver Dashboard │
└────────────────┘   └────────────────────┘        └─────────────────────┘
```

## フロントエンド構成（`front/`）
- `front/src/app`
  - アプリシェル、ルーティング、レイアウト、言語切替、保護者ゲート画面。
- `front/src/core`
  - `engine`: セッション→ゲーム→報酬への遷移とタイミングを制御するステートマシン。
  - `adaptive`: 難易度調整、ストリーク検知、エラーリカバリを担う。
  - `rewards`: 音・アニメーション・ボイスを統合し、変動比率スケジュールを運用。
  - `telemetry`: 成功率・反応時間などを記録し、平滑化や将来の送信フックを提供。
- `front/src/modules`
  - `rhythm-tap`: パターン生成、タイミング評価、視覚化を担当。
  - `pair-match`: カード配置生成、めくりアニメーション、記憶判定を担当。
  - 追加モジュールは `init` / `startRound` / `evaluate` / `cleanup` を実装して共通契約に従う。
- `front/src/ui`
  - 進捗バー、ストリーク通知、タイマー、ヒントポップなどの共通HUD。
- `front/src/state`
  - Zustandストアでセッション情報、プレイヤープロファイル、報酬キューを管理。
  - IndexedDB（`idb-keyval`）による永続化アダプタと、未対応環境用のlocalStorageフォールバック。

## モジュール契約
- **ゲームモジュールインターフェース**
  - `config`: Lv1〜Lv4の難易度帯とパラメータ範囲を提供。
  - `prepare(context)`: アセットの事前読み込みとラウンド指標の初期化。
  - `generateRound(difficulty)`: スティミュラス（課題）を生成。
  - `evaluate(input, round)`: 成功可否、反応時間、ヒント利用回数を返却。
  - `teachHint(round)`: 連続失敗時に提示するガイド付き補助を返す。
- **適応エンジン**
  - 最新ラウンド指標をもとに成功率を滑らかに算出。
  - 連勝時に難易度を一段階ずつ上げ、連敗時は下げるなど、過度の挫折を防ぐヒューリスティックを備える。
  - 3連勝・5連勝・10連勝などの節目で報酬システムに通知し、変動報酬を発火。

## データとテレメトリの流れ
1. **ラウンド開始**: エンジンが適応モジュールから次ラウンドの難易度設定を取得。
2. **プレイヤー入力**: ゲームモジュールが結果情報（成功可否・反応時間・ミス）を返却。
3. **テレメトリ更新**: ローカルにデータを蓄積し、適応ロジックへフィードバック。
4. **報酬判定**: 報酬システムが音声・視覚演出の種類を決定し、過刺激を避けるクールダウンを制御。
5. **ダッシュボード連携**: セッション要約（成功率、ストリーク、プレイ時間）を保護者ビューに表示し、次回セッションに引き継ぐ。

## 適応ルール概要
- 初期難易度は直近ラウンドの結果をベースにし、保護者設定は演出強度のみを制御。
- `successRate > 0.85` で難易度を一段階引き上げ、`< 0.7` で下げる。
- 反応時間が一定割合で短縮した場合、二次刺激（テンポ変化など）を導入。
- 連続3回失敗で `teachHint` を発火し、成功するまで難易度上昇を停止。

## 報酬メカニクス
- `howler.js`による効果音、Canvasアニメーション、i18n対応ボイスを0.5秒以内に発火。
- 変動比率スケジュールを採用し、予測不能な「スーパー報酬」をストリーク節目で付与。
- 保護者向けには、強化が成功体験重視であることを示すサマリーを提供。

## オフライン & PWA 戦略
- サービスワーカーがアプリシェル、主要アセット、言語バンドルを初回読込時にキャッシュ。
- テレメトリキューをオフライン保持し、将来のバックエンド実装時に同期できる設計とする。
- 音声が利用できない環境では、可能であれば触覚フィードバックにフォールバック。

## 将来のバックエンド統合（`backend/` プレースホルダー）
- 進捗同期API、分析集約、保護者ダッシュボード拡張などを想定。
- イベントスキーマは `front/src/core/telemetry/schema.ts` で型定義し、バックエンド実装前から契約を明確化。
- 子どもの識別子はローカルでハッシュ化し、保護者アカウントとの紐付けは明示的同意時のみ実施。

## 目的整合性チェック
- 適応学習ループ、即時報酬、保護者への透明性、将来の拡張性という中核ミッションを守り続ける構成となっている。
- モジュール境界を明確にすることで、新規ゲーム追加や機能拡張のたびに「できた！」体験を増やすことに集中できる。
